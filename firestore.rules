rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.role == 'admin';
    }
    
    function validateString(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }
    
    function isNotBanned() {
      return isAuthenticated() && 
             (!exists(/databases/$(database)/documents/profiles/$(request.auth.uid)) ||
              get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.get('banned', false) == false);
    }
    
    // Profiles - users can read all, write their own with validation, admins can ban users
    match /profiles/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId) && 
                      validateString(request.resource.data.username, 3, 20) &&
                      request.resource.data.username.matches('^[a-zA-Z0-9_]+$');
      allow update: if (isOwner(userId) && isNotBanned()) ||
                      // Admins can update banned status and role
                      (isAdmin());
      allow delete: if false; // Prevent profile deletion
    }
    
    // Usernames - for uniqueness checks with validation
    match /usernames/{username} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
                      request.resource.data.uid == request.auth.uid &&
                      username.size() >= 3 && username.size() <= 20 &&
                      username.matches('^[a-z0-9_]+$');
      allow delete: if isAuthenticated() && 
                      resource.data.uid == request.auth.uid;
      allow update: if false; // Usernames are immutable
    }
    
    // Private messages - only sender and receiver with validation, admins can view all
    match /private_messages/{messageId} {
      allow read: if isAdmin() || 
                    (isAuthenticated() && isNotBanned() &&
                     (resource.data.sender_id == request.auth.uid || 
                      resource.data.receiver_id == request.auth.uid));
      allow create: if isAuthenticated() && isNotBanned() &&
                      request.resource.data.sender_id == request.auth.uid &&
                      validateString(request.resource.data.content, 1, 4096) &&
                      request.resource.data.receiver_id is string &&
                      request.resource.data.receiver_id != request.auth.uid;
      allow update: if isAuthenticated() && isNotBanned() &&
                     (resource.data.sender_id == request.auth.uid ||
                      resource.data.receiver_id == request.auth.uid);
      allow delete: if false; // Prevent message deletion
    }
    
    // Typing status - with proper validation
    match /typing_status/{statusId} {
      allow read: if isAuthenticated() && isNotBanned();
      allow write: if isAuthenticated() && isNotBanned() &&
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.isTyping is bool;
      allow delete: if isAuthenticated();
    }
    
    // Groups - Authenticated users can read and create groups
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotBanned() &&
                      request.resource.data.created_by == request.auth.uid &&
                      validateString(request.resource.data.name, 1, 50) &&
                      request.resource.data.members.hasAll([request.auth.uid]);
      allow update: if isAuthenticated() && isNotBanned() &&
                      (resource.data.created_by == request.auth.uid || 
                       resource.data.admins.hasAny([request.auth.uid]));
    }
    
    // Group Members - Members can be added/viewed
    match /groups/{groupId}/members/{memberId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isNotBanned();
    }

    // Group Messages - Members can send messages
    match /group_messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isNotBanned() &&
                      (request.resource.data.sender_id == request.auth.uid || request.resource.data.sender_id == 'system');
      allow update: if false; // Messages are immutable
    }
  }
}
